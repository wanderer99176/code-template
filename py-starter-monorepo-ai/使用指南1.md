好的，这是为你优化和补充完整的 **《企业级全栈 AI 应用 Monorepo 模板使用指南》** 最终版。

本指南完全基于 **Windows 11** 环境，优先使用 **Git Bash** 终端，并遵循 **Chocolatey 管理系统软件、pipx 管理 Python 工具** 的原则。所有命令行都添加了序号和中文注释。

-----

# 企业级全栈 AI 应用 Monorepo 模板使用指南 (Windows 11 完整版)

> 📚 本指南将手把手教你如何使用这个模板创建、开发和部署一个完整的企业级全栈 AI 应用。

## 📋 目录

  - [第一步：环境准备](https://www.google.com/search?q=%23%E7%AC%AC%E4%B8%80%E6%AD%A5%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87)
  - [第二步：创建项目与 GitHub 仓库](https://www.google.com/search?q=%23%E7%AC%AC%E4%BA%8C%E6%AD%A5%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE%E4%B8%8E-github-%E4%BB%93%E5%BA%93)
  - [第三步：初始化项目](https://www.google.com/search?q=%23%E7%AC%AC%E4%B8%89%E6%AD%A5%E5%88%9D%E5%A7%8B%E5%8C%96%E9%A1%B9%E7%9B%AE)
  - [第四步：启动开发环境](https://www.google.com/search?q=%23%E7%AC%AC%E5%9B%9B%E6%AD%A5%E5%90%AF%E5%8A%A8%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83)
  - [第五步：开发工作流](https://www.google.com/search?q=%23%E7%AC%AC%E4%BA%94%E6%AD%A5%E5%BC%80%E5%8F%91%E5%B7%A5%E4%BD%9C%E6%B5%81)
  - [第六步：本地测试](https://www.google.com/search?q=%23%E7%AC%AC%E5%85%AD%E6%AD%A5%E6%9C%AC%E5%9C%B0%E6%B5%8B%E8%AF%95)
  - [第七步：部署到生产环境](https://www.google.com/search?q=%23%E7%AC%AC%E4%B8%83%E6%AD%A5%E9%83%A8%E7%BD%B2%E5%88%B0%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83)
  - [第八步：监控和维护](https://www.google.com/search?q=%23%E7%AC%AC%E5%85%AB%E6%AD%A5%E7%9B%91%E6%8E%A7%E5%92%8C%E7%BB%B4%E6%8A%A4)
  - [常见问题](https://www.google.com/search?q=%23%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98)
  - [进一步学习](https://www.google.com/search?q=%23%E8%BF%9B%E4%B8%80%E6%AD%A5%E5%AD%A6%E4%B9%A0)

-----

## 第一步：环境准备

本节将在 Windows 11 系统上，使用 Chocolatey 和 pipx 搭建完整的开发环境。

### 1.1 安装 Chocolatey (系统级包管理器)

如果你还没有安装 Chocolatey，请先安装它。

```powershell
# 1. 以管理员身份打开 PowerShell
# 2. 执行以下命令来安装 Chocolatey
Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))

# 3. 安装完成后，关闭并重新打开一个管理员 PowerShell 终端，验证安装
choco --version
```

### 1.2 安装核心开发工具

现在，我们将使用 Chocolatey 安装所有必要的系统级软件。

```powershell
# 1. 在管理员 PowerShell 终端中，执行以下命令
#    这将安装 Git, Python 3.11.9, Node.js (LTS), Docker Desktop, 和 Just
choco install git python --version=3.11.9 nodejs-lts docker-desktop just -y

# 2. 安装完成后，请重新启动你的电脑以确保所有环境变量和系统设置正确生效
```

### 1.3 安装语言级工具 (pipx, uv, pnpm)

**从现在开始，所有操作都在普通的 Git Bash 终端中进行。**

```bash
# 1. 安装 pipx (用于管理 Python CLI 工具)
#    pip 随 Python 安装时已自带
pip install --user pipx
pipx ensurepath

# 2. 关闭并重新打开一个 Git Bash 终端，让 pipx 路径生效

# 3. 使用 pipx 安装 uv (高性能 Python 包管理器) 和 cookiecutter (项目模板工具)
pipx install uv
pipx install cookiecutter

# 4. 使用 npm (随 Node.js 安装时已自带) 安装 pnpm
npm install -g pnpm
```

### 1.4 验证所有工具

在 **Git Bash** 终端中运行以下命令，确保所有工具都已正确安装并能找到。

```bash
# 1. 逐一检查各个工具的版本
git --version          # 应该显示 2.x+
python --version       # 应该显示 Python 3.11.9
node --version         # 应该显示 v20.x.x (LTS)
pnpm --version         # 应该显示 8.x+
uv --version           # 应该显示 0.x.x
pipx --version         # 应该显示 1.x+
cookiecutter --version # 应该显示 2.x+
choco --version        # 应该显示 2.x+
just --version         # 应该显示 1.x+ (可选)
docker --version       # 应该显示 24.x+, 请确保 Docker Desktop 正在运行
```

-----

## 第二步：创建项目与 GitHub 仓库

### 2.1 在 GitHub 上创建仓库

1.  打开 [GitHub](https://github.com/) 并登录。
2.  点击右上角的 `+` 号，选择 `New repository`。
3.  填写 `Repository name`，例如 `my-ai-platform`。
4.  **非常重要**：不要勾选任何 `Initialize this repository with` 下的选项（如 `Add a README file`, `Add .gitignore`）。我们需要一个完全空的仓库。
5.  点击 `Create repository`。
6.  复制页面上提供的 HTTPS 或 SSH 仓库地址，稍后会用到。

### 2.2 从模板创建本地项目

现在，使用 `cookiecutter` 在你的本地电脑上生成项目代码。

```bash
# 1. 创建一个用于存放项目的目录，例如 D:\projects
mkdir -p D:/projects
cd D:/projects

# 2. 从 GitHub 模板仓库创建项目
cookiecutter gh:wanderer99176/code-template --directory py-starter-monorepo-ai
```

### 2.3 填写项目信息

Cookiecutter 会引导你填写一系列项目信息，请根据你的实际情况填写。

```bash
# 示例填写过程
[1/22] project_name (My Enterprise AI App): 我的AI应用平台
[2/22] project_slug (my-ai-platform): my-ai-platform
[3/22] package_name (my_ai_platform): my_ai_platform
# ... 其他选项可以根据提示选择或直接回车使用默认值
```

### 2.4 验证项目创建

```bash
# 1. 进入刚刚创建的项目目录
cd my-ai-platform

# 2. 查看项目结构
ls -F
# 你应该能看到 infra/, services/, package.json 等文件和目录
```

-----

## 第三步：初始化项目

本节将完成项目的完整初始化，包括生成 `.gitignore`、关联远程仓库、安装依赖等。

### 3.1 生成 `.gitignore` 文件

我们将使用 `gibo` 的思想，从 [toptal.com/developers/gitignore](https://www.toptal.com/developers/gitignore) 生成一份推荐的忽略列表。

```bash
# 1. 在项目根目录 (my-ai-platform) 下，执行以下命令
#    这将下载一份针对 Python, Node, VSCode, Windows 和 Docker 的 .gitignore 文件
curl -L -o .gitignore https://www.toptal.com/developers/gitignore/api/python,node,visualstudiocode,windows,docker
```

### 3.2 关联远程 GitHub 仓库

将本地生成的代码推送到你在 GitHub 上创建的空仓库。

```bash
# 1. 初始化本地 Git 仓库
git init

# 2. 添加所有文件到暂存区
git add .

# 3. 创建首次提交
git commit -m "feat: initial commit from template"

# 4. 将主分支重命名为 main
git branch -M main

# 5. 添加远程仓库地址 (请替换为你自己的仓库地址)
git remote add origin https://github.com/zhangsan/my-ai-platform.git

# 6. 推送代码到 GitHub
git push -u origin main
```

### 3.3 使用 `just` 自动初始化（推荐）

现在可以运行一键初始化命令，它会自动完成所有繁琐的配置。

```bash
# 1. 查看所有可用的 just 命令
just --list

# 2. 运行初始化命令
just init
```

`just init` 会自动完成以下步骤：

1.  ✅ 安装 pnpm 依赖
2.  ✅ 为每个 Python 服务创建虚拟环境并安装依赖
3.  ✅ 设置 pre-commit hooks
4.  ✅ 从 `.env.example` 复制生成 `.env` 文件
5.  ✅ 启动 Docker Compose 基础服务 (PostgreSQL, Redis, MinIO)
6.  ✅ 运行数据库迁移

-----

## 第四步：启动开发环境

### 4.1 使用 `just` 启动（推荐）

```bash
# 1. 一键启动所有开发服务
#    这将并行启动 backend, frontend, ml-api 等
just dev
```

### 4.2 手动启动各个服务

如果你想单独控制每个服务，可以打开多个 Git Bash 终端分别启动。

```bash
# 终端 1: 启动 Backend 服务
(cd services/backend && source .venv/Scripts/activate && uvicorn my_ai_platform.main:app --reload --host 0.0.0.0 --port 8000)

# 终端 2: 启动 Frontend 服务
(cd services/frontend && pnpm dev)

# 终端 3: 启动 ML API (如果启用)
(cd services/ml-api && source .venv/Scripts/activate && uvicorn main:app --reload --host 0.0.0.0 --port 8001)
```

### 4.3 验证服务运行

  - **Frontend**: `http://localhost:3000`
  - **Backend API Docs**: `http://localhost:8000/docs`
  - **ML API Docs**: `http://localhost:8001/docs` (如果启用)

### 4.4 启动监控服务（可选）

```bash
# 1. (推荐) 使用 Just 启动监控套件
just monitoring-up

# 2. 或者使用 Docker Compose 手动启动
docker-compose -f infra/docker-compose/monitoring.yml up -d

# 3. 访问监控面板
#    - Grafana: http://localhost:3001 (默认账户: admin/admin)
#    - Prometheus: http://localhost:9090
#    - Jaeger: http://localhost:16686
```

-----

## 第五步：开发工作流

### 5.1 添加新的 API 端点

#### 步骤 1: 创建端点文件

```bash
# 1. 进入 backend 的 endpoints 目录 (请替换 my_ai_platform 为你的包名)
cd services/backend/src/my_ai_platform/api/v1/endpoints

# 2. 使用 here-document 快速创建一个 products.py 文件
cat > products.py << 'EOF'
from fastapi import APIRouter
router = APIRouter()
@router.get("/products")
async def get_products():
    return {"products": [{"id": 1, "name": "示例产品"}]}
EOF

# 3. 返回项目根目录
cd ../../../../../../..
```

#### 步骤 2: 注册新路由

用你的代码编辑器打开 `services/backend/src/my_ai_platform/api/v1/router.py` 文件，添加 `products` 路由。

```python
# api/v1/router.py
from fastapi import APIRouter
from .endpoints import auth, users, health, products  # 1. 导入 products

api_router = APIRouter()
# ... 其他路由
api_router.include_router(products.router, prefix="/products", tags=["产品"])  # 2. 添加这行
```

#### 步骤 3: 生成 TypeScript 类型

```bash
# 1. (推荐) 使用 just 一键生成
just codegen

# 2. 或手动执行 pnpm 脚本
pnpm codegen
```

### 5.2 添加数据库模型

#### 步骤 1: 创建模型

编辑 `services/backend/src/my_ai_platform/db/models.py`，添加 `Product` 模型。

```python
# db/models.py
from sqlmodel import SQLModel, Field
from typing import Optional
from datetime import datetime

class Product(SQLModel, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    name: str = Field(index=True)
    price: float
```

#### 步骤 2: 创建数据库迁移文件

```bash
# 1. (推荐) 使用 just 生成迁移文件，并添加描述
just db-migrate name="add_product_table"

# 2. 或手动执行 alembic 命令
(cd services/backend && source .venv/Scripts/activate && alembic revision --autogenerate -m "add_product_table")
```

#### 步骤 3: 应用迁移到数据库

```bash
# 1. (推荐) 使用 just 应用迁移
just db-upgrade

# 2. 或手动执行 alembic 命令
(cd services/backend && source .venv/Scripts/activate && alembic upgrade head)
```

-----

## 第六步：本地测试

### 6.1 运行单元测试

```bash
# 1. (推荐) 使用 just 运行所有服务的测试
just test

# 2. 或单独运行后端测试
(cd services/backend && source .venv/Scripts/activate && pytest)

# 3. 或单独运行前端测试
(cd services/frontend && pnpm test)
```

### 6.2 运行测试并生成覆盖率报告

```bash
# 1. 使用 just 一键运行并生成报告
just test-cov

# 2. 在浏览器中打开生成的报告
#    - Backend: services/backend/htmlcov/index.html
#    - Frontend: services/frontend/coverage/lcov-report/index.html
```

-----

## 第七步：部署到生产环境

### 7.1 本地 Docker 部署

```bash
# 1. (推荐) 使用 just 构建所有服务的 Docker 镜像
just docker-build

# 2. 启动所有服务
docker-compose -f infra/docker-compose/prod.yml up -d

# 3. 查看服务状态
docker-compose -f infra/docker-compose/prod.yml ps
```

### 7.2 部署到 Kubernetes

```bash
# 1. 确保你的 kubectl 已配置好并连接到目标集群
kubectl cluster-info

# 2. (推荐) 使用 just 部署所有应用
just k8s-deploy

# 3. 或使用 Helm 手动部署
helm upgrade --install backend ./infra/kubernetes/helm-charts/backend -n my-ai-platform --create-namespace
helm upgrade --install frontend ./infra/kubernetes/helm-charts/frontend -n my-ai-platform

# 4. 查看部署状态
kubectl get all -n my-ai-platform
```

### 7.3 部署到 AWS (使用 OpenTofu/Terraform)

```bash
# 1. 确保你的 AWS CLI 已配置好凭证
aws sts get-caller-identity

# 2. 进入 IaC 代码目录
cd infra/tofu

# 3. 初始化 Tofu (仅首次需要)
just tf-init

# 4. 查看将要创建的资源计划
just tf-plan

# 5. 应用计划，创建云上基础设施 (VPC, EKS, RDS 等)
#    此操作耗时较长 (15-20 分钟) 且会产生费用
just tf-apply
```

-----

## 第八步：监控和维护

### 8.1 查看应用日志 (Kubernetes)

```bash
# 1. (推荐) 使用 just 查看 backend 服务的日志
just logs backend

# 2. 或使用 kubectl 手动查看
kubectl logs -f deployment/backend -n my-ai-platform
```

### 8.2 数据库备份

```bash
# 1. (推荐) 使用 just 执行备份，它会自动将备份文件存放到 S3 (需配置)
just db-backup

# 2. 或在本地手动备份
docker-compose -f infra/docker-compose/dev.yml exec postgres pg_dump -U my_ai_platform_user my_ai_platform_db > backup.sql
```

### 8.3 应用更新 (Kubernetes)

```bash
# 1. 在 CI/CD 流水线构建并推送新镜像后，触发滚动更新
kubectl rollout restart deployment/backend -n my-ai-platform
kubectl rollout restart deployment/frontend -n my-ai-platform

# 2. 监控更新状态
kubectl rollout status deployment/backend -n my-ai-platform
```

### 8.4 扩缩容 (Kubernetes)

```bash
# 1. 手动将 backend 服务扩容到 5 个实例
kubectl scale deployment/backend --replicas=5 -n my-ai-platform
```

-----

## 常见问题

### Q1: 端口被占用怎么办？

```bash
# 1. 在 Git Bash 中查找占用 3000 端口的进程
netstat -ano | findstr :3000

# 2. 记下最后一列的进程 ID (PID)，例如 12345
# 3. 使用 taskkill 命令终止该进程
taskkill /PID 12345 /F
```

### Q2: Docker 服务启动失败？

```bash
# 1. 查看指定服务 (例如 postgres) 的详细日志
docker-compose -f infra/docker-compose/dev.yml logs -f postgres

# 2. 如果数据损坏，可以彻底清理并重建 (会删除数据库数据！)
docker-compose -f infra/docker-compose/dev.yml down -v
docker-compose -f infra/docker-compose/dev.yml up -d --build
```

### Q3: 数据库迁移失败？

```bash
# 1. 进入 backend 目录并激活虚拟环境
cd services/backend
source .venv/Scripts/activate

# 2. 查看迁移历史记录
alembic history

# 3. 如果需要，回滚到上一个版本
alembic downgrade -1
```

### Q4: 如何清理所有资源？

```bash
# 1. (推荐) 使用 just 关闭并清理所有本地开发环境资源
just dev-down

# 2. 销毁 AWS 基础设施 (⚠️ 警告: 此操作不可逆，会删除所有云上资源！)
(cd infra/tofu && just tf-destroy)
```

-----

## 进一步学习

1.  **官方文档**:
      - [FastAPI 文档](https://fastapi.tiangolo.com/)
      - [Nuxt 3 文档](https://nuxt.com/)
      - [Kubernetes 文档](https://kubernetes.io/docs/)
2.  **项目文档**:
      - `docs/setup-guide.md`
      - `docs/deployment.md`
      - `docs/adr/`

-----

## 🎉 下一步

恭喜！你已经成功创建并部署了一个企业级全栈 AI 应用。接下来你可以：

1.  🔧 **定制功能**: 根据业务需求添加新的 API 端点和页面
2.  🤖 **集成 AI**: 利用 ML API 和 Audio API 构建智能功能
3.  🚀 **持续优化**: 根据监控数据优化性能和成本

**祝开发愉快！** 🚀