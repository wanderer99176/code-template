# Justfile - é¡¹ç›®ä»»åŠ¡è¿è¡Œå™¨
# å®‰è£… just: https://github.com/casey/just
# ä½¿ç”¨: just <command>

# é»˜è®¤å‘½ä»¤ï¼šæ˜¾ç¤ºæ‰€æœ‰å¯ç”¨å‘½ä»¤
default:
    @just --list

# === å¼€å‘ç¯å¢ƒ ===

# åˆå§‹åŒ–é¡¹ç›®ï¼ˆé¦–æ¬¡è¿è¡Œï¼‰
init:
    @echo "ğŸš€ åˆå§‹åŒ–é¡¹ç›®..."
    chmod +x scripts/*.sh
    ./scripts/setup.sh

# å¯åŠ¨å¼€å‘ç¯å¢ƒ
dev:
    @echo "ğŸ”§ å¯åŠ¨å¼€å‘ç¯å¢ƒ..."
    docker-compose -f infra/docker-compose/dev.yml up -d
    pnpm install
    pnpm dev

# åœæ­¢å¼€å‘ç¯å¢ƒ
dev-down:
    @echo "ğŸ›‘ åœæ­¢å¼€å‘ç¯å¢ƒ..."
    docker-compose -f infra/docker-compose/dev.yml down

# === æ„å»º ===

# æ„å»ºæ‰€æœ‰æœåŠ¡
build:
    @echo "ğŸ“¦ æ„å»ºæ‰€æœ‰æœåŠ¡..."
    pnpm build
    cd services/backend && uv sync
    cd services/ml-api && uv sync
    cd services/audio-api && uv sync

# æ„å»º Docker é•œåƒ
docker-build:
    @echo "ğŸ³ æ„å»º Docker é•œåƒ..."
    docker-compose build

# æ„å»ºå¹¶æ¨é€é•œåƒåˆ°ä»“åº“
docker-push registry="{{ cookiecutter.docker_registry }}/{{ cookiecutter.github_username }}":
    @echo "ğŸ“¤ æ¨é€é•œåƒåˆ° {% raw %}{{ registry }}{% endraw %}..."
    docker-compose build
    docker tag {{ cookiecutter.project_slug }}-backend:latest {% raw %}{{ registry }}{% endraw %}/{{ cookiecutter.project_slug }}-backend:latest
    docker tag {{ cookiecutter.project_slug }}-frontend:latest {% raw %}{{ registry }}{% endraw %}/{{ cookiecutter.project_slug }}-frontend:latest
    docker push {% raw %}{{ registry }}{% endraw %}/{{ cookiecutter.project_slug }}-backend:latest
    docker push {% raw %}{{ registry }}{% endraw %}/{{ cookiecutter.project_slug }}-frontend:latest

# === æµ‹è¯• ===

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
test:
    @echo "ğŸ§ª è¿è¡Œæ‰€æœ‰æµ‹è¯•..."
    pnpm test
    cd services/backend && uv run pytest
    cd services/ml-api && uv run pytest
    cd services/audio-api && uv run pytest

# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
test-cov:
    @echo "ğŸ“Š è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š..."
    pnpm test:coverage
    cd services/backend && uv run pytest --cov
    cd services/ml-api && uv run pytest --cov
    cd services/audio-api && uv run pytest --cov

# === ä»£ç è´¨é‡ ===

# è¿è¡Œæ‰€æœ‰ linters
lint:
    @echo "ğŸ” è¿è¡Œ linters..."
    pnpm lint
    cd services/backend && uv run ruff check .
    cd services/ml-api && uv run ruff check .
    cd services/audio-api && uv run ruff check .

# è‡ªåŠ¨ä¿®å¤ lint é—®é¢˜
lint-fix:
    @echo "ğŸ”§ è‡ªåŠ¨ä¿®å¤ lint é—®é¢˜..."
    pnpm lint:fix
    cd services/backend && uv run ruff check --fix .
    cd services/ml-api && uv run ruff check --fix .
    cd services/audio-api && uv run ruff check --fix .

# æ ¼å¼åŒ–ä»£ç 
format:
    @echo "âœ¨ æ ¼å¼åŒ–ä»£ç ..."
    pnpm format
    cd services/backend && uv run ruff format .
    cd services/ml-api && uv run ruff format .
    cd services/audio-api && uv run ruff format .

# ç±»å‹æ£€æŸ¥
typecheck:
    @echo "ğŸ” ç±»å‹æ£€æŸ¥..."
    pnpm typecheck
    cd services/backend && uv run mypy .

# === æ•°æ®åº“ ===

# åˆ›å»ºæ•°æ®åº“è¿ç§»
db-migrate name:
    @echo "ğŸ“ åˆ›å»ºæ•°æ®åº“è¿ç§»: {% raw %}{{ name }}{% endraw %}..."
    cd services/backend && uv run alembic revision --autogenerate -m "{% raw %}{{ name }}{% endraw %}"

# åº”ç”¨æ•°æ®åº“è¿ç§»
db-upgrade:
    @echo "â¬†ï¸  åº”ç”¨æ•°æ®åº“è¿ç§»..."
    cd services/backend && uv run alembic upgrade head

# å›æ»šæ•°æ®åº“è¿ç§»
db-downgrade:
    @echo "â¬‡ï¸  å›æ»šæ•°æ®åº“è¿ç§»..."
    cd services/backend && uv run alembic downgrade -1

# é‡ç½®æ•°æ®åº“
db-reset:
    @echo "ğŸ”„ é‡ç½®æ•°æ®åº“..."
    docker-compose -f infra/docker-compose/dev.yml down -v
    docker-compose -f infra/docker-compose/dev.yml up -d postgres
    sleep 3
    just db-upgrade

# å¤‡ä»½æ•°æ®åº“
db-backup:
    @echo "ğŸ’¾ å¤‡ä»½æ•°æ®åº“..."
    ./scripts/db-backup.sh

# === ä»£ç ç”Ÿæˆ ===

# ç”Ÿæˆ TypeScript ç±»å‹
codegen:
    @echo "âš¡ ç”Ÿæˆ TypeScript ç±»å‹..."
    ./scripts/codegen.sh

# === Kubernetes ===

# åº”ç”¨ Kubernetes é…ç½®
k8s-apply:
    @echo "â˜¸ï¸  åº”ç”¨ Kubernetes é…ç½®..."
    kubectl apply -f infra/kubernetes/core-infra/

# éƒ¨ç½²åˆ° Kubernetes
k8s-deploy:
    @echo "ğŸš€ éƒ¨ç½²åˆ° Kubernetes..."
    helm upgrade --install backend infra/kubernetes/helm-charts/backend/
    helm upgrade --install frontend infra/kubernetes/helm-charts/frontend/

# æŸ¥çœ‹ Kubernetes çŠ¶æ€
k8s-status:
    @echo "ğŸ“Š Kubernetes çŠ¶æ€..."
    kubectl get pods -n {{ cookiecutter.kubernetes_namespace }}
    kubectl get svc -n {{ cookiecutter.kubernetes_namespace }}

# === OpenTofu/Terraform ===

# åˆå§‹åŒ– Terraform
tf-init:
    @echo "ğŸ—ï¸  åˆå§‹åŒ– Terraform..."
    cd infra/tofu && tofu init

# Terraform è®¡åˆ’
tf-plan:
    @echo "ğŸ“‹ Terraform è®¡åˆ’..."
    cd infra/tofu && tofu plan

# åº”ç”¨ Terraform å˜æ›´
tf-apply:
    @echo "âœ… åº”ç”¨ Terraform å˜æ›´..."
    cd infra/tofu && tofu apply

# é”€æ¯åŸºç¡€è®¾æ–½
tf-destroy:
    @echo "ğŸ’£ é”€æ¯åŸºç¡€è®¾æ–½..."
    cd infra/tofu && tofu destroy

# === ç›‘æ§ ===

# å¯åŠ¨ç›‘æ§å¥—ä»¶
monitoring-up:
    @echo "ğŸ“Š å¯åŠ¨ç›‘æ§å¥—ä»¶..."
    docker-compose -f infra/docker-compose/monitoring.yml up -d

# åœæ­¢ç›‘æ§å¥—ä»¶
monitoring-down:
    @echo "ğŸ›‘ åœæ­¢ç›‘æ§å¥—ä»¶..."
    docker-compose -f infra/docker-compose/monitoring.yml down

# === æ¸…ç† ===

# æ¸…ç†æ„å»ºäº§ç‰©
clean:
    @echo "ğŸ§¹ æ¸…ç†æ„å»ºäº§ç‰©..."
    pnpm clean
    find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
    find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
    find . -type d -name ".ruff_cache" -exec rm -rf {} + 2>/dev/null || true
    find . -type d -name "dist" -exec rm -rf {} + 2>/dev/null || true

# æ·±åº¦æ¸…ç†ï¼ˆåŒ…æ‹¬ node_modules å’Œè™šæ‹Ÿç¯å¢ƒï¼‰
clean-all: clean
    @echo "ğŸ§¹ğŸ§¹ æ·±åº¦æ¸…ç†..."
    find . -type d -name "node_modules" -exec rm -rf {} + 2>/dev/null || true
    find . -type d -name ".venv" -exec rm -rf {} + 2>/dev/null || true
    find . -type d -name "venv" -exec rm -rf {} + 2>/dev/null || true

# === æ–‡æ¡£ ===

# ç”Ÿæˆ API æ–‡æ¡£
docs-api:
    @echo "ğŸ“š ç”Ÿæˆ API æ–‡æ¡£..."
    cd services/backend && uv run python -m mkdocs build

# å¯åŠ¨æ–‡æ¡£æœåŠ¡å™¨
docs-serve:
    @echo "ğŸ“– å¯åŠ¨æ–‡æ¡£æœåŠ¡å™¨..."
    cd services/backend && uv run python -m mkdocs serve

# === å®‰å…¨ ===

# å®‰å…¨å®¡è®¡
security-audit:
    @echo "ğŸ”’ å®‰å…¨å®¡è®¡..."
    pnpm audit
    cd services/backend && uv run pip-audit
    cd services/ml-api && uv run pip-audit
    cd services/audio-api && uv run pip-audit

# æ‰«æ Docker é•œåƒæ¼æ´
security-scan-docker:
    @echo "ğŸ” æ‰«æ Docker é•œåƒ..."
    docker scan {{ cookiecutter.project_slug }}-backend:latest
    docker scan {{ cookiecutter.project_slug }}-frontend:latest

# === CI/CD ===

# æ¨¡æ‹Ÿ CI æµç¨‹
ci:
    @echo "ğŸ¤– æ¨¡æ‹Ÿ CI æµç¨‹..."
    just lint
    just typecheck
    just test
    just build

# === å…¶ä»– ===

# æŸ¥çœ‹æ—¥å¿—
logs service="":
    @if [ -z "{% raw %}{{ service }}{% endraw %}" ]; then \
        docker-compose logs -f; \
    else \
        docker-compose logs -f {% raw %}{{ service }}{% endraw %}; \
    fi

# è¿›å…¥å®¹å™¨ shell
shell service:
    docker-compose exec {% raw %}{{ service }}{% endraw %} sh

# æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯
info:
    @echo "ğŸ“¦ é¡¹ç›®: {{ cookiecutter.project_name }}"
    @echo "ğŸ“Œ ç‰ˆæœ¬: {{ cookiecutter.version }}"
    @echo "ğŸ‘¤ ä½œè€…: {{ cookiecutter.author_name }}"
    @echo "ğŸ Python: {{ cookiecutter.python_version }}"
    @echo "ğŸ“— Node: {{ cookiecutter.node_version }}"

